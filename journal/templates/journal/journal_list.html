{% extends "journal/base_journal.html" %}
{% block content %}
<style>
  body { background: linear-gradient(160deg, #336F97, #48C9B0, #FFB84D); color: #FFFFFF; font-family: 'Poppins', sans-serif; margin: 0; overflow-x: hidden; }
  nav.navbar { display: none !important; }

  .sidebar { position: fixed; top: 0; left: 0; width: 240px; height: 100vh; background: linear-gradient(180deg, #48C9B0, #336F97);
      display: flex; flex-direction: column; align-items: center; padding: 2rem 1rem; border-top-right-radius: 25px; border-bottom-right-radius: 25px; box-shadow: 4px 0 15px rgba(0, 0, 0, 0.25); z-index: 100; }
  .sidebar h2 { color: #FFD700; font-weight: 700; font-size: 1.4rem; margin-bottom: 2rem; text-align: center; text-shadow: 0 0 8px rgba(255, 215, 0, 0.5); }
  .sidebar nav a { display: block; color: #FFFFFF; text-decoration: none; margin: 15px 0; padding: 10px 20px; width: 85%; text-align: left; border-radius: 10px; font-weight: 500; transition: all 0.3s ease; }
  .sidebar nav a:hover { background-color: #FFB84D; color: #2C3E50; transform: translateX(5px); box-shadow: 0 0 8px rgba(255, 215, 0, 0.4); }
  .sidebar .footer { margin-top: auto; text-align: center; color: #FFD700; font-weight: 600; font-size: 0.9rem; }

  .content { margin-left: 260px; padding: 2rem 2rem 4rem; display: flex; flex-direction: column; align-items: flex-start; gap: 1.2rem; }

  .card { background: linear-gradient(180deg, #336F97, #48C9B0); border-radius: 15px; padding: 1.1rem 1.2rem; width: 90%; max-width: 840px; margin-left: 1rem; box-shadow: 0 3px 8px rgba(0,0,0,.3); }
  .card.sun { background: linear-gradient(135deg, #48C9B0, #FFB84D, #FFD700); color: #1f2a35; }
  .card h1, .card h2, .card h3 { margin: 0 0 .6rem 0; }
  .muted { color: #e8f6ffcc; font-size: .95rem; }

  textarea.input { border: none; border-radius: 15px; resize: vertical; padding: 12px; width: 100%; color: #2C3E50; font-size: 1rem; background-color: rgba(255, 255, 255, 0.95); box-shadow: inset 0 0 6px rgba(0, 0, 0, 0.1); }
  textarea.input:focus { outline: none; box-shadow: 0 0 0 3px #FFD700; }

  .row-end { display: flex; gap: .6rem; justify-content: flex-end; align-items: center; }
  .btn { border: none; border-radius: 12px; padding: .5rem .9rem; font-weight: 700; cursor: pointer; }
  .btn.primary { background: #4dabf7; color: #163047; }
  .btn.ghost { background: transparent; color: #fff; border: 1px solid rgba(255,255,255,.35); }
  .btn.sun { background: #FFD700; color:#2C3E50; box-shadow: 0 4px 8px rgba(0,0,0,.25); }
  .btn.sun:hover { background:#FFB84D; }

  .list { list-style: none; padding: 0; margin: 0; }
  .item { padding: .7rem 0; border-bottom: 1px dashed rgba(255,255,255,.2); }
  .item .meta { color: #ffeaa7; font-size: .92rem; margin-bottom: .25rem; }

  .alert { background: rgba(255,255,255,.15); border: 1px solid rgba(255,255,255,.3); padding: .6rem .8rem; border-left: 4px solid; border-radius: 10px; }
  .alert.error { border-left-color: #e55353; }
  .alert.warn  { border-left-color: #d8a657; }
  .messages { width: 90%; max-width: 840px; margin-left: 1rem; }

  /* grid de dos columnas en pantallas amplias */
  .two-cols { display: grid; grid-template-columns: 1.2fr .8fr; gap: 1.2rem; width: 100%; }
  @media (max-width: 980px) { .two-cols { grid-template-columns: 1fr; } }
</style>

<div class="sidebar">
  <h2>üåü Inner Light AI</h2>
  <nav>
    <a href="{% url 'journal:list' %}">ü™∂ Mi Diario</a>
    <a href="{% url 'journal:community' %}">üåê Comunidad</a>
    <a href="{% url 'logout' %}">üìñ Cerrar Sesi√≥n</a>
  </nav>
  <div class="footer">Illuminate Your Inner Path ‚ú®</div>
</div>

<div class="content">
  {% if messages %}
    <div class="messages">
      {% for message in messages %}
        <div class="alert {% if message.tags == 'error' %}error{% elif message.tags == 'warning' %}warn{% endif %}">{{ message }}</div>
      {% endfor %}
    </div>
  {% endif %}

  <div class="two-cols">
    <!-- Columna izquierda: escribir y listar -->
    <div class="left">
      <div class="card sun">
        <h1>üìù Tu diario</h1>
        <form method="post" action="">
          {% csrf_token %}
          <textarea class="input" name="content" rows="6" placeholder="¬øQu√© est√°s pensando ahora?"></textarea>
          <div class="row-end" style="margin-top:.6rem">
            <a class="btn ghost" href="{% url 'journal:community' %}">Ir a Comunidad</a>
            <button class="btn primary" type="submit">Guardar</button>
          </div>
        </form>
      </div>

      <div class="card">
        <h2>Tus entradas</h2>
        {% if entries %}
          <ul class="list">
            {% for e in entries %}
              <li class="item">
                <div class="meta">{{ e.created_at|date:"Y-m-d H:i" }}</div>
                <div class="text">{{ e.content }}</div>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="muted">A√∫n no has escrito nada. Empieza con una frase corta.</p>
        {% endif %}
      </div>
    </div>

    <!-- Columna derecha: an√°lisis IA -->
    <div class="right">
      <div class="card sun">
        <div class="row-end">
          <a class="btn sun" href="{% url 'journal:analyze' %}">Analizar</a>
        </div>

        {% if analysis_error %}
          <div class="alert error" style="margin:.6rem 0">An√°lisis generado con errores: {{ analysis_error }}</div>
        {% elif analysis_warning %}
          <div class="alert warn" style="margin:.6rem 0">{{ analysis_warning }}</div>
        {% endif %}

        {% if last_analysis_dt %}
          <div class="muted">√öltimo an√°lisis: {{ last_analysis_dt|date:"Y-m-d H:i" }}</div>
        {% endif %}

        {% if analysis_data %}
          {% with d=analysis_data %}
            {% if d.emociones %}
              <h3 style="margin-top:.6rem">Emociones</h3>
              <ul class="list">
                {% for emo in d.emociones %}
                  <li class="item" style="border:0; padding:.3rem 0">
                    <strong>{{ emo.nombre }}</strong> ¬∑ {{ emo.frecuencia }}{% if emo.evidencia %} ‚Äî <span class="muted">{{ emo.evidencia }}</span>{% endif %}
                  </li>
                {% endfor %}
              </ul>
            {% endif %}

            {% if d.disparadores %}
              <h3 style="margin-top:.6rem">Disparadores</h3>
              <ul class="list">
                {% for tr in d.disparadores %}
                  <li class="item" style="border:0; padding:.3rem 0">
                    {{ tr.tipo }}{% if tr.ejemplos %} ‚Äî <span class="muted">{{ tr.ejemplos|join:", " }}</span>{% endif %}
                  </li>
                {% endfor %}
              </ul>
            {% endif %}

            {% if d.patrones %}
              <h3 style="margin-top:.6rem">Patrones</h3>
              <ul class="list">
                {% for p in d.patrones %}
                  <li class="item" style="border:0; padding:.3rem 0">
                    <b>{{ p.nombre }}</b> ‚Äî {{ p.descripcion }}
                    {% if p.frases_representativas %}
                      <div class="muted">‚Äú{{ p.frases_representativas|join:"‚Äù ¬∑ ‚Äú" }}‚Äù</div>
                    {% endif %}
                  </li>
                {% endfor %}
              </ul>
            {% endif %}

            {% if d.necesidades %}
              <h3 style="margin-top:.6rem">Necesidades</h3>
              <ul class="list">
                {% for n in d.necesidades %}
                  <li class="item" style="border:0; padding:.3rem 0">{{ n.descripcion }}</li>
                {% endfor %}
              </ul>
            {% endif %}

            {% if d.recomendaciones %}
              <h3 style="margin-top:.6rem">Recomendaciones</h3>
              <ul class="list">
                {% for r in d.recomendaciones %}
                  <li class="item" style="border:0; padding:.4rem 0">
                    <b>{{ r.practica }}</b> ¬∑ {{ r.frecuencia }}
                    {% if r.pasos %}
                      <ol style="margin:.3rem 0 0 1.1rem">
                        {% for s in r.pasos %}<li>{{ s }}</li>{% endfor %}
                      </ol>
                    {% endif %}
                  </li>
                {% endfor %}
              </ul>
            {% endif %}
          {% endwith %}
        {% else %}
          <p class="muted" style="margin-top:.6rem">A√∫n no has generado un an√°lisis. Escribe algunas entradas y pulsa ‚ÄúAnalizar‚Äù.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}
