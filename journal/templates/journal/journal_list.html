{% extends "journal/base_journal.html" %}
{% block content %}
<style>
  body {
    background: radial-gradient(circle at top, #48C9B0 0, #336F97 40%, #102a43 100%);
    color: #FFFFFF;
    font-family: 'Poppins', sans-serif;
    margin: 0;
    overflow-x: hidden;
  }
  nav.navbar { display: none !important; }

  .sidebar {
    position: fixed; top: 0; left: 0; width: 240px; height: 100vh;
    background: linear-gradient(180deg, #48C9B0, #336F97);
    display: flex; flex-direction: column; align-items: center;
    padding: 2rem 1rem;
    border-top-right-radius: 25px; border-bottom-right-radius: 25px;
    box-shadow: 4px 0 15px rgba(0, 0, 0, 0.25);
    z-index: 100;
  }
  .sidebar h2 {
    color: #FFD700; font-weight: 700; font-size: 1.4rem;
    margin-bottom: 2rem; text-align: center;
    text-shadow: 0 0 8px rgba(255, 215, 0, 0.5);
  }
  .sidebar nav a {
    display: block; color: #FFFFFF; text-decoration: none;
    margin: 15px 0; padding: 10px 20px; width: 85%;
    text-align: left; border-radius: 10px; font-weight: 500;
    transition: all 0.3s ease;
  }
  .sidebar nav a:hover {
    background-color: #FFB84D; color: #2C3E50;
    transform: translateX(5px);
    box-shadow: 0 0 8px rgba(255, 215, 0, 0.4);
  }
  .sidebar .footer {
    margin-top: auto; text-align: center; color: #FFD700;
    font-weight: 600; font-size: 0.9rem;
  }

  .content {
    margin-left: 260px;
    padding: 2rem 2rem 4rem;
    display: flex; flex-direction: column; align-items: center; gap: 1rem;
  }

  .shell {
    width: 100%; max-width: 900px;
    display: flex; flex-direction: column;
    gap: 0.8rem;
  }

  .card {
    background: linear-gradient(180deg, #224567, #2f8c96);
    border-radius: 18px;
    padding: 1.1rem 1.2rem;
    box-shadow: 0 3px 15px rgba(0,0,0,.35);
  }

  .messages-box { width: 100%; }
  .alert {
    background: rgba(255,255,255,.15);
    border: 1px solid rgba(255,255,255,.3);
    padding: .6rem .8rem;
    border-left: 4px solid;
    border-radius: 10px;
    margin-bottom: .45rem;
  }
  .alert.error { border-left-color: #e55353; }
  .alert.warn  { border-left-color: #d8a657; }

  /* Chat thread */
  .chat-thread {
    display: flex;
    flex-direction: column;
    gap: 0.8rem;
  }
  .chat-message {
    display: flex;
    gap: .6rem;
  }
  .chat-avatar {
    width: 32px; height: 32px;
    border-radius: 999px;
    display: flex; align-items: center; justify-content: center;
    font-size: .8rem; font-weight: 700;
  }
  .chat-avatar.user { background: #4dabf7; color:#0b2840; }
  .chat-avatar.ai   { background: #FFD700; color:#634300; }

  .chat-bubble {
    flex: 1;
    padding: .55rem .75rem;
    border-radius: 14px;
    font-size: .93rem;
    line-height: 1.45;
    background: linear-gradient(135deg,#163a5b,#224567);
    border: 1px solid rgba(255,255,255,.15);
  }
  .chat-bubble.ai {
    background: linear-gradient(135deg,#12324a,#215b68);
  }

  .chat-meta {
    display:flex; justify-content:space-between; align-items:center;
    font-size: .78rem;
    color: #9fb3c8;
    margin-bottom: .15rem;
  }

  .entry-actions {
    display:flex; gap:.4rem; font-size:.78rem;
  }
  .entry-actions a,
  .entry-actions button {
    background:none; border:none; padding:0;
    color:#a5b9d6; cursor:pointer;
  }
  .entry-actions a:hover,
  .entry-actions button:hover {
    color:#FFD700;
    text-decoration: underline;
  }

  .section-title {
    font-weight: 600; margin-top: .3rem; margin-bottom: .1rem;
  }
  .section-list {
    margin: .15rem 0 .3rem 1.1rem; padding-left: .4rem;
  }
  .section-list li { margin-bottom: .1rem; }

  /* Input area */
  .input-card {
    background: rgba(10, 26, 48, 0.9);
    border-radius: 18px;
    padding: .9rem 1rem;
    box-shadow: 0 3px 15px rgba(0,0,0,.4);
  }
  textarea.input {
    border: none; border-radius: 12px; resize: vertical;
    padding: 10px; width: 100%; color: #2C3E50; font-size: .95rem;
    background-color: rgba(255, 255, 255, 0.97);
    box-shadow: inset 0 0 6px rgba(0, 0, 0, 0.1);
  }
  textarea.input:focus { outline: none; box-shadow: 0 0 0 3px #FFD700; }

  .input-actions {
    display: flex; justify-content: space-between; align-items: center;
    gap: .6rem; margin-top: .5rem;
  }
  .input-hint {
    font-size: .8rem; color: #cbd6e3;
  }

  .btn {
    border: none; border-radius: 12px; padding: .5rem .9rem;
    font-weight: 700; cursor: pointer; font-size: .9rem;
  }
  .btn.primary { background: #4dabf7; color: #163047; }
  .btn.secondary { background: #FFD700; color:#2C3E50; }
  .btn.ghost { background: transparent; color: #fff; border: 1px solid rgba(255,255,255,.35); }

</style>

<div class="sidebar">
  <h2>üåü Inner Light AI</h2>
  <nav>
    <a href="{% url 'journal:list' %}">ü™∂ Mi Diario</a>
    <a href="{% url 'journal:community' %}">üåê Comunidad</a>
    <a href="{% url 'logout' %}">üìñ Cerrar Sesi√≥n</a>
  </nav>
  <div class="footer">Illuminate Your Inner Path ‚ú®</div>
</div>

<div class="content">
  <div class="shell">
    {% if messages %}
      <div class="messages-box">
        {% for message in messages %}
          <div class="alert {% if message.tags == 'error' %}error{% elif message.tags == 'warning' %}warn{% endif %}">
            {{ message }}
          </div>
        {% endfor %}
      </div>
    {% endif %}

    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:.5rem;">
        <div>
          <h2 style="margin:0;">üß† Inner Light Journal</h2>
          <p style="margin:.15rem 0 0; font-size:.85rem; color:#cddff5;">
            Escribe libremente. Cuando quieras, pulsa <strong>‚ÄúAnalizar todo‚Äù</strong> para que la IA lea tu diario completo.
          </p>
        </div>
        <div style="text-align:right;">
          <a class="btn secondary" href="{% url 'journal:analyze' %}">Analizar todo</a>
          {% if last_analysis_dt %}
            <div style="font-size:.75rem; color:#cddff5; margin-top:.15rem;">
              √öltimo an√°lisis: {{ last_analysis_dt|date:"Y-m-d H:i" }}
            </div>
          {% endif %}
        </div>
      </div>

      <div class="chat-thread">
        {# 1) Entradas del usuario como mensajes #}
        {% if entries %}
          {% for e in entries %}
            <div class="chat-message">
              <div class="chat-avatar user">T√∫</div>
              <div class="chat-bubble">
                <div class="chat-meta">
                  <span>{{ e.created_at|date:"Y-m-d H:i" }}</span>
                  <span class="entry-actions">
                    <a href="{% url 'journal:entry_edit' e.id %}">Editar</a>
                    <form method="post" action="{% url 'journal:entry_delete' e.id %}" style="display:inline;" onsubmit="return confirm('¬øSeguro que quieres eliminar esta entrada?');">
                      {% csrf_token %}
                      <button type="submit">Eliminar</button>
                    </form>
                  </span>
                </div>
                <div>{{ e.content }}</div>
              </div>
            </div>
          {% endfor %}
        {% else %}
          <div class="chat-message">
            <div class="chat-avatar user">T√∫</div>
            <div class="chat-bubble">
              <div class="chat-meta">Sin mensajes a√∫n</div>
              <div>Empieza escribiendo c√≥mo te sientes hoy. Luego podr√°s pedirle a Inner Light AI que analice todo tu proceso.</div>
            </div>
          </div>
        {% endif %}

        {# 2) Respuesta de la IA (√∫ltimo an√°lisis) #}
        {% if analysis_error %}
          <div class="chat-message">
            <div class="chat-avatar ai">IL</div>
            <div class="chat-bubble ai">
              <div class="section-title">Error en el an√°lisis</div>
              <p>{{ analysis_error }}</p>
            </div>
          </div>
        {% elif analysis_data %}
          <div class="chat-message">
            <div class="chat-avatar ai">IL</div>
            <div class="chat-bubble ai">
              <div class="chat-meta">
                <span>An√°lisis espiritual generado</span>
                {% if last_analysis_dt %}
                  <span>{{ last_analysis_dt|date:"Y-m-d H:i" }}</span>
                {% endif %}
              </div>

              {% if analysis_data.estado_emocional_central %}
                <div class="section-title">Estado emocional central</div>
                <p>{{ analysis_data.estado_emocional_central }}</p>
              {% endif %}

              {% if analysis_data.patrones_pensamiento %}
                <div class="section-title">Patrones de pensamiento predominantes</div>
                <ul class="section-list">
                  {% for p in analysis_data.patrones_pensamiento %}
                    <li>{{ p }}</li>
                  {% endfor %}
                </ul>
              {% endif %}

              {% if analysis_data.creencias_limitantes %}
                <div class="section-title">Creencias limitantes</div>
                <ul class="section-list">
                  {% for c in analysis_data.creencias_limitantes %}
                    <li>{{ c }}</li>
                  {% endfor %}
                </ul>
              {% endif %}

              {% if analysis_data.herida_emocional_raiz %}
                <div class="section-title">Herida emocional ra√≠z</div>
                <p>{{ analysis_data.herida_emocional_raiz }}</p>
              {% endif %}

              {% if analysis_data.interpretacion_espiritual %}
                <div class="section-title">Interpretaci√≥n espiritual</div>
                <p>{{ analysis_data.interpretacion_espiritual|linebreaks }}</p>
              {% endif %}

              {% if analysis_data.consejo_practico %}
                <div class="section-title">Consejo pr√°ctico</div>
                <p>{{ analysis_data.consejo_practico|linebreaks }}</p>
              {% endif %}

              {% if analysis_data.consejo_espiritual %}
                <div class="section-title">Consejo espiritual</div>
                <p>{{ analysis_data.consejo_espiritual|linebreaks }}</p>
              {% endif %}

              {% if analysis_data.meditacion_guiada %}
                <div class="section-title">Meditaci√≥n guiada</div>
                <p>{{ analysis_data.meditacion_guiada|linebreaks }}</p>
              {% endif %}

              {% if analysis_data.raw_text %}
                <div class="section-title">Respuesta bruta de la IA (debug)</div>
                <pre style="font-size:.78rem; white-space:pre-wrap;">{{ analysis_data.raw_text }}</pre>
              {% endif %}

              {% if analysis_warning %}
                <div class="section-title">Nota</div>
                <p>{{ analysis_warning }}</p>
              {% endif %}
            </div>
          </div>
        {% endif %}
      </div>
    </div>

    <div class="input-card">
      <form method="post" action="">
        {% csrf_token %}
        <textarea class="input" name="content" rows="3" placeholder="Escribe aqu√≠ tu siguiente reflexi√≥n, sue√±o o pensamiento..."></textarea>
        <div class="input-actions">
          <div class="input-hint">
            Inner Light AI te leer√° mejor mientras m√°s honesto seas contigo mismo.  
            Primero guarda tus mensajes, luego pulsa ‚ÄúAnalizar todo‚Äù.
          </div>
          <div style="display:flex; gap:.5rem;">
            <a class="btn ghost" href="{% url 'journal:community' %}">Ir a Comunidad</a>
            <button class="btn primary" type="submit">Guardar mensaje</button>
          </div>
        </div>
      </form>
    </div>

  </div>
</div>
{% endblock %}
