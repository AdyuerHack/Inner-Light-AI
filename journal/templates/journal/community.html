{% extends "journal/base_journal.html" %}
{% block content %}
<style>
  body { background: linear-gradient(160deg, #336F97, #48C9B0, #FFB84D); color: #FFFFFF; font-family: 'Poppins', sans-serif; margin: 0; overflow-x: hidden; }
  nav.navbar { display: none !important; }

  .sidebar { position: fixed; top: 0; left: 0; width: 240px; height: 100vh; background: linear-gradient(180deg, #48C9B0, #336F97);
    display: flex; flex-direction: column; align-items: center; padding: 2rem 1rem; border-top-right-radius: 25px; border-bottom-right-radius: 25px; box-shadow: 4px 0 15px rgba(0, 0, 0, 0.25); z-index: 100; }
  .sidebar h2 { color: #FFD700; font-weight: 700; font-size: 1.4rem; margin-bottom: 2rem; text-align: center; text-shadow: 0 0 8px rgba(255, 215, 0, 0.5); }
  .sidebar nav a { display: block; color: #FFFFFF; text-decoration: none; margin: 15px 0; padding: 10px 20px; width: 85%; text-align: left; border-radius: 10px; font-weight: 500; transition: all 0.3s ease; }
  .sidebar nav a:hover { background-color: #FFB84D; color: #2C3E50; transform: translateX(5px); box-shadow: 0 0 8px rgba(255, 215, 0, 0.4); }
  .sidebar .footer { margin-top: auto; text-align: center; color: #FFD700; font-weight: 600; font-size: 0.9rem; }

  .content { margin-left: 260px; padding: 2rem 2rem 4rem; display: flex; flex-direction: column; align-items: flex-start; }

  .header-card { background: linear-gradient(135deg, #48C9B0, #FFB84D, #FFD700); border-radius: 18px; padding: 1.2rem 1.5rem; box-shadow: 0 6px 10px rgba(0, 0, 0, 0.2); margin-bottom: 2rem; width: 90%; max-width: 520px; margin-left: 1rem; }
  /* Forzamos visibilidad del textarea del form */
  .header-card textarea { display: block !important; width: 100%; min-height: 84px; border: none; border-radius: 15px; resize: vertical; padding: 10px; color: #2C3E50; font-size: 1rem; background-color: rgba(255, 255, 255, 0.95); box-shadow: inset 0 0 6px rgba(0, 0, 0, 0.1); }
  .header-card textarea:focus { outline: none; box-shadow: 0 0 0 3px #FFD700; }

  .toolbar { display: flex; align-items: center; gap: .6rem; margin-top: .6rem; }
  .icon-btn { display:inline-flex; align-items:center; justify-content:center; width: 34px; height: 34px; border-radius: 999px; background: rgba(255,255,255,.12); border: 1px solid rgba(255,255,255,.25); cursor: pointer; transition: transform .15s ease, background .2s ease; }
  .icon-btn:hover { transform: scale(1.05); background: rgba(255,255,255,.2); }
  .icon { width: 18px; height: 18px; display: inline-block; }

  .visually-hidden, #id_image, #id_video { position: absolute !important; left: -9999px !important; width: 1px; height: 1px; overflow: hidden; }

  .btn-publish { margin-left: auto; background-color: #FFD700; color: #2C3E50; border: none; border-radius: 18px; font-weight: bold; padding: .45rem 1rem; box-shadow: 0 4px 8px rgba(0,0,0,.25); }
  .btn-publish:hover { background-color: #FFB84D; }

  .media-box { position: relative; width: 100%; max-width: 520px; aspect-ratio: 4/3; border-radius: 12px; overflow: hidden; background: rgba(0,0,0,.25); box-shadow: inset 0 0 1px rgba(255,255,255,.2); }
  .media-box img, .media-box video { width: 100%; height: 100%; object-fit: cover; display: block; }
  .media-box video { cursor: pointer; }

  .preview-wrap { margin-top: .6rem; display: none; }
  .preview-card { width: 100%; max-width: 520px; }
  .preview-card .media-box { margin-bottom: .4rem; }
  .preview-remove { background: transparent; color: #fff; border: 1px solid rgba(255,255,255,.35); padding: .3rem .6rem; border-radius: 999px; cursor: pointer; }

  .post-card { background: linear-gradient(180deg, #336F97, #48C9B0); border-radius: 15px; padding: 1.1rem 1.2rem; margin-bottom: 1.1rem; width: 90%; max-width: 520px; margin-left: 1rem; box-shadow: 0 3px 8px rgba(0,0,0,.3); }
  .post-header { display:flex; justify-content: space-between; align-items: center; }
  .username { font-weight: 600; color: #FFD700; text-shadow: 0 0 6px rgba(255, 215, 0, 0.6); }
  .post-media { margin: .6rem 0; }

  .reaction-bar { display: flex; justify-content: space-around; margin-top: 0.3rem; }
  .reaction-bar a { text-decoration: none; color: #FFB84D; font-size: 1.1rem; transition: transform 0.2s ease, color 0.3s; }
  .reaction-bar a:hover { transform: scale(1.2); color: #FFD700; }

  .comment-section { margin-top: .6rem; padding-top: 0.6rem; border-top: 1px solid rgba(255,255,255,0.2); }
  .comment { background: rgba(255,255,255,0.1); border-radius: 10px; padding: 8px 12px; margin: 6px 0; color: #FFF; font-size: 0.9rem; }
  .comment-form textarea { height: 40px; font-size: 0.9rem; }
  .comment-form button { margin-top: 5px; background-color: #FFD700; color: #2C3E50; border-radius: 10px; font-weight: bold; padding: 5px 12px; border: none; cursor: pointer; }

  .messages { width: 90%; max-width: 520px; margin-left: 1rem; margin-bottom: .6rem; }
  .msg { background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.25); padding: .6rem .9rem; border-radius: 10px; margin-bottom: .5rem; }

  .form-errors { margin:.5rem 0; color:#2C3E50; background:#FFE08A; border-radius:10px; padding:.5rem .75rem; font-weight:600; }
</style>

<div class="sidebar">
  <h2>üåü Inner Light AI</h2>
  <nav>
    <a href="{% url 'journal:list' %}">ü™∂ Mi Diario</a>
    <a href="{% url 'journal:community' %}">üåê Comunidad</a>
    <a href="{% url 'logout' %}">üìñ Cerrar Sesi√≥n</a>
  </nav>
  <div class="footer">Illuminate Your Inner Path ‚ú®</div>
</div>

<div class="content">
  {% if messages %}
    <div class="messages">
      {% for message in messages %}
        <div class="msg">{{ message }}</div>
      {% endfor %}
    </div>
  {% endif %}

  <!-- Composer -->
  <div class="card header-card">
    <form method="POST" action="{% url 'journal:create_post' %}" enctype="multipart/form-data">
      {% csrf_token %}

      {% if post_form.non_field_errors %}
        <div class="form-errors">{{ post_form.non_field_errors }}</div>
      {% endif %}
      {{ post_form.content.errors }}
      {{ post_form.content }}

      <div class="toolbar">
        <!-- Emojis -->
        <button id="emoji-btn" type="button" class="icon-btn" title="Emojis"><span class="icon">üòä</span></button>

        <!-- Imagen -->
        <label for="id_image" class="icon-btn" title="A√±adir imagen">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="5" width="18" height="14" rx="2"></rect>
            <circle cx="8.5" cy="10.5" r="1.5"></circle>
            <path d="M21 17l-5.5-5.5a2 2 0 0 0-2.9 0L4 21"></path>
          </svg>
        </label>

        <!-- Video -->
        <label for="id_video" class="icon-btn" title="A√±adir video">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="5" width="18" height="14" rx="2"></rect>
            <polygon points="10,9 16,12 10,15"></polygon>
          </svg>
        </label>

        {{ post_form.image }}
        {{ post_form.video }}

        <button type="submit" class="btn-publish">Publicar</button>
      </div>

      <!-- PREVIEW IMAGEN -->
      <div id="image-preview-wrap" class="preview-wrap">
        <div class="preview-card">
          <div class="media-box">
            <img id="image-preview" alt="Vista previa imagen">
          </div>
          <button id="remove-image" type="button" class="preview-remove">Quitar imagen</button>
        </div>
      </div>

      <!-- PREVIEW VIDEO -->
      <div id="video-preview-wrap" class="preview-wrap">
        <div class="preview-card">
          <div class="media-box">
            <video id="video-preview" controls muted playsinline></video>
          </div>
          <button id="remove-video" type="button" class="preview-remove">Quitar video</button>
        </div>
      </div>
    </form>
  </div>

  {% for post in posts %}
    <div class="post-card">
      <div class="post-header">
        <span class="username">Usuario An√≥nimo üïäÔ∏è</span>
        <span class="small text-light">{{ post.created_at|date:"d/m/Y H:i" }}</span>
      </div>

      {% if post.content %}<p class="mt-2 mb-2">{{ post.content|linebreaks }}</p>{% endif %}

      <div class="post-media">
        {% if post.image %}
          <div class="media-box"><img src="{{ post.image.url }}" alt="Imagen del post"></div>
        {% endif %}
        {% if post.video %}
          <div class="media-box"><video src="{{ post.video.url }}" controls playsinline></video></div>
        {% endif %}
      </div>

      <div class="reaction-bar">
        <a href="{% url 'journal:react_to_post' post.id 'heart' %}">‚ù§Ô∏è {{ post.heart_count }}</a>
        <a href="{% url 'journal:react_to_post' post.id 'laugh' %}">üòÇ {{ post.laugh_count }}</a>
        <a href="{% url 'journal:react_to_post' post.id 'pray' %}">üôè {{ post.pray_count }}</a>
        <a href="{% url 'journal:react_to_post' post.id 'sad' %}">üò¢ {{ post.sad_count }}</a>
        <a href="{% url 'journal:react_to_post' post.id 'light' %}">üåü {{ post.light_count }}</a>
      </div>

      <div class="comment-section">
        {% for comment in post.comments.all %}
          <div class="comment">
            <p>{{ comment.content }}</p>
            <small>üí¨ Usuario An√≥nimo ‚Äî {{ comment.created_at|date:"d/m/Y H:i" }}</small>
          </div>
        {% empty %}
          <p style="font-size: 0.9rem; color: #ddd;">S√© el primero en comentar üå±</p>
        {% endfor %}
        <form method="POST" action="{% url 'journal:add_comment' post.id %}" class="comment-form">
          {% csrf_token %}
          <textarea name="content" placeholder="‚úçÔ∏è Escribe un comentario..." required></textarea>
          <button type="submit">Responder</button>
        </form>
      </div>
    </div>
  {% empty %}
    <p class="no-posts">üåô A√∫n no hay publicaciones. S√© la primera luz del d√≠a.</p>
  {% endfor %}
</div>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js" type="module"></script>

<script>
  // Emoji Picker
  const emojiBtn = document.getElementById('emoji-btn');
  const textArea = document.querySelector('.emoji-input') || document.querySelector('textarea[name="content"]');
  const picker = document.createElement('emoji-picker');
  picker.style.position = 'fixed'; picker.style.zIndex = '1000'; picker.style.display = 'none'; picker.style.bottom = '90px'; picker.style.left = '300px';
  document.body.appendChild(picker);
  emojiBtn?.addEventListener('click', (e) => { e.preventDefault(); picker.style.display = picker.style.display === 'none' ? 'block' : 'none'; });
  picker.addEventListener('emoji-click', ev => { if (textArea) { textArea.value += ev.detail.unicode; textArea.focus(); } picker.style.display = 'none'; });

  // Validaci√≥n cliente (5 MB) y previews
  const MAX_BYTES = 5 * 1024 * 1024;
  const IMG_TYPES = ['image/jpeg','image/png','image/webp'];
  const VID_TYPES = ['video/mp4','video/webm','video/ogg'];

  const imgInput = document.getElementById('id_image');
  const vidInput = document.getElementById('id_video');

  const imgWrap = document.getElementById('image-preview-wrap');
  const imgPrev = document.getElementById('image-preview');
  const imgRemove = document.getElementById('remove-image');

  const vidWrap = document.getElementById('video-preview-wrap');
  const vidPrev = document.getElementById('video-preview');
  const vidRemove = document.getElementById('remove-video');

  function clearImage() { imgPrev.src=''; imgWrap.style.display='none'; if (imgInput) imgInput.value=''; }
  function clearVideo() { vidPrev.removeAttribute('src'); vidPrev.load(); vidWrap.style.display='none'; if (vidInput) vidInput.value=''; }

  imgInput?.addEventListener('change', () => {
    const f = imgInput.files && imgInput.files[0];
    if (!f) return clearImage();
    if (!IMG_TYPES.includes(f.type)) { alert('Formato no permitido. Usa JPG, PNG o WebP.'); return clearImage(); }
    if (f.size > MAX_BYTES) { alert('La imagen es muy pesada (m√°x. 5 MB).'); return clearImage(); }
    const reader = new FileReader();
    reader.onload = e => { imgPrev.src = e.target.result; imgWrap.style.display='block'; };
    reader.readAsDataURL(f);
  });
  imgRemove?.addEventListener('click', (e) => { e.preventDefault(); clearImage(); });

  vidInput?.addEventListener('change', () => {
    const f = vidInput.files && vidInput.files[0];
    if (!f) return clearVideo();
    if (!VID_TYPES.includes(f.type)) { alert('Formato de video no permitido. Usa MP4, WebM u Ogg.'); return clearVideo(); }
    if (f.size > MAX_BYTES) { alert('El video es muy pesado (m√°x. 5 MB).'); return clearVideo(); }
    const url = URL.createObjectURL(f);
    vidPrev.src = url;
    vidWrap.style.display = 'block';
  });
  vidRemove?.addEventListener('click', (e) => { e.preventDefault(); clearVideo(); });
</script>
{% endblock %}
